# Arbitrum Rollup 协议

原文链接：[Arbitrum Rollup Protocol](https://developer.offchainlabs.com/docs/rollup_protocol)

## Arbitrum Rollup 协议设计

Arbitrum Rollup 是一个由链上以太坊合约管理的链下协议。 dApp 开发人员可能会希望将自己以 Solidity 编写的一个或一组合同部署到 Layer 2 Arbitrum Rollup 链（ArbChain）上。

本文档从概念上描述了该设计，然后在某种程度上进行了形式上的描述。 最后，假设一位诚实的涉众，我们证明该协议可确保安全并最终取得进展。

### Rollup 的基础

让我们从基础开始。 VM的状态被组织为Merkle树，因此可以计算VM状态的加密哈希。 在协议的任何时候，VM的某些状态都已被完全确认并处于最终状态。 它的哈希存储在链上。

协议的参与者可以提出一个有争议的声明（DA），该声明声称，从某种状态哈希开始，并且具有一些技术先决条件，VM可以执行指定数量的计算步骤，从而导致指定的新状态哈希， 并且VM在该计算期间进行指定的付款并发出指定的日志事件。 DA可能有效（即真实）或无效。 制定DA的一方将被要求在DA的有效性上押金。 （有关赌注及其运作方式的更多信息，请参见下文。）

![img](https://developer.offchainlabs.com/docs/assets/rollupGraph1.png)

如上所述，争议声明会创建一个逻辑决策点，协议最终将必须解决该逻辑决策点。 如果DA有效，则系统将在右上角输入新状态，并带有新的状态哈希，并具有DA中指定的副作用（付款和日志）。 或在另一分支上，DA无效； 它被拒绝并且VM的状态保持不变。

### Arbitrum 2.0 协议

当前的Arbitrum协议比原始的Arbitrum协议有了重要的进步，因为它支持多个流水线DA。在新协议中，每个状态最多可以跟随一个DA。 如果DA没有跟随状态，则任何人都可以创建跟随它的DA，从而创建新的分支点。 结果将是一棵可能的期货树，如下图所示。

![img](https://developer.offchainlabs.com/docs/assets/rollupGraph2.png)

### 质押

该协议的另一个重要部分是抵押。任何人都可以在树上的一个方形盒子上放一个木桩。通过在一个正方形上放样，您可以断言该正方形将最终被协议确认。换句话说，您断言您已沿着从当前状态到所放样的平方的路径在每个DA处都采取了正确的分支。如果您错了，那么您可能会失去赌注。

放样操作无法撤消。您可以将赌注向右移动（选择在每个分支点上移或下移），但不能向左移动，因为这等于撤销了您先前做出的下注承诺。

提出有争议的主张的一方必须与该DA的“ DA有效”后继者建立关系。通常，他们可以通过将现有股权移至右侧以将其放置在所需的后继方上来满足此要求。如果他们还没有放下股份，他们将不得不提供股份。

关于放样的更多详细信息：如果您放样的广场被确认并成为公认的历史记录，则您可以选择收回放样。这意味着，如果您是对的，则可以将赌注保持在原位置，然后等待系统“追赶”您的赌注，然后您就可以收回赌注。

在这一点上，您可能会担心可能性之树会变得很大且分支状。实际上这不太可能发生，因为这将需要多方参与互不相同的结果。他们中只有一个是正确的，其他所有人都将失去本金。更有可能的是，“树”实际上是一串串有效的DA，每个赌注都具有相同的结果。下图显示了这种典型情况：基本上，一组“流水线” DA最终可能会全部被接受。

![img](https://developer.offchainlabs.com/docs/assets/rollupGraph3.png)

### 质押截止日期

我们需要系统在过多时间之前就每个有争议的断言做出决定。 因此，当将DA添加到链中并创建分支点时，最后期限与该DA相关联。 将来的截止日期已经足够长了，每个人都将有时间检查DA是否有效，并选择是否进行链上交易以抵押DA的结果。 如果有人想为该DA的有效性做出承诺或反对，则必须在截止日期之前这样做。 （仍然可以在截止日期之后引入风险，但是它们不会参与决定或反对该DA。）一旦达到截止日期，与确定该DA相关的所有风险将为人所知。

### 争论

如果爱丽丝（Alice）和鲍勃（Bob）被押在不同的正方形上，那么两件事之一就是正确的。 从其中一个到另一个将有向右移动的路径（这意味着他们的主张彼此一致），或者将没有这样的路径。 如果没有将爱丽丝和鲍勃的正方形连接起来的向右移动的路径，那么他们必须在某些问题上存在分歧。 它们之间始终存在唯一的争议点-唯一的DA，其中一个被押于该DA有效，而另一个被押于该DA无效。

![img](https://developer.offchainlabs.com/docs/assets/rollupGraph4.png)

每当两方之间发生争议时，系统都可以启动双方之间的交互式争议解决协议。争端解决协议在其他地方进行了描述-在这里足以说它是一种两部分型交互式协议，与我们在其他Arbitrum文档中所描述的类似。争端议定书要求当事各方轮流采取行动，并规定每项行动的最后期限。未能在截止日期前采取行动的一方将放弃该挑战。

争端解决协议的结果是，将发现一方不正确。那个党将没收他们的股份。桩子将从其所在的正方形上删除。争议中的一部分将提供给另一方，其余的将被烧掉。

争议解决可以确定两个争议方之一是不正确的，但是我们不能推断出另一方一定是正确的。也许双方都犯了错误，或者也许双方正在串通以“煮熟”争端的结果。由于存在这些可能性，因此在争端结束时，发生的一切只是输了败者的股份。 （失败者的一半股份用于争端的胜者，另一半则被烧掉。）

可以同时进行多个争议，但是每个涉众最多可以同时处理一个争议。由于将消除输家的赌注，因此每次纠纷都会减少系统中的分歧。失去赌注的参与者可以根据需要重新进行赌注，但是新赌注将无法影响已经超过赌注截止时间的发展议程。这样的结果是，在DA的争夺截止日期过去之后，争执将逐渐消除关于如何处理该DA的任何分歧。

### 结果的确认

一旦DA的放样截止时间过去，并且所有剩余的及时（在放样截止日期之前放置）的股份都位于该DA的同一分支（上部或下部），则系统可以确认该DA的结果。 DA被接受或拒绝，并且当前状态移至DA右侧的适当方框。 如果DA被确认为有效，则其副作用（如付款）将在链上实现。 这就是VM的状态前进的方式。

在通常情况下，当事方将诚实行事，因为他们不想通过对虚假主张进行赌注来失去赌注。 在单个链中仅会声明有效的DA，而没有人会押在任何DA的无效分支上。 在这种情况下，每个DA的放样期限都可以立即得到确认。

### 为什么它是无需信任的

Arbitrum Rollup的一个重要特性是它不受信任-单个诚实方可以迫使VM正确运行并取得进步。 要了解为什么，请想象一下，爱丽丝总是在每个DA的真实分支上放样，并且如果树变空了，她就会断言DA。 如果其他人做出了错误的DA，爱丽丝则反对。

因为爱丽丝在真正的分支机构上有赌注，所以她将赢得所遇到的每一个纠纷。 如果其他人不同意爱丽丝，则他们要么（a）失去与第三方的无关纠纷的股份，要么（b）最终与爱丽丝发生纠纷并失去对她的股份。 无论哪种方式，每个不同意爱丽丝的人都将最终失去他们的股份。 只有与爱丽丝同意的木桩才能幸存，因此，爱丽丝穿过这棵树的路径最终将是唯一拥有及时木桩的树木-并且爱丽丝的路径将得到确认。

![img](https://developer.offchainlabs.com/docs/assets/rollupGraph5.png)

因为系统以这种方式是不可信的，所以如果爱丽丝被押在一个正方形上并且她知道通往那个正方形的路径是真实的，那么爱丽丝可以确定她所在的正方形将最终得到确认。 就爱丽丝而言，这条路和最终路一样好。

即使您未涉足某个路径，如果您看到有人涉足该路径，并且您相信其中至少有一个人是诚实的，那么您可以确定该路径最终会得到确认-到目前为止 就您而言，这条路和最终路一样好。

### 无需信任的可确定性的好处

为什么对结果具有不信任的确定性很有价值？经典示例来自之前对其他汇总协议的讨论。假设虚拟机要向Alice付款。付款活动本来就很诚实，但要过一会儿才能在链上确认付款发生的地点，这将是一阵子。

不受信任的最终决定使爱丽丝有一种方法，可以立即拿到她的钱。如果鲍勃没有支配的钱，他可以立即将其交给爱丽丝，以换取爱丽丝将未来尚未确认的付款分配给鲍勃（加上向鲍勃支付最低限度的费用）。鲍勃只有在可以确定付款确实会发生的情况下才会这样做。鲍勃可以通过坚持诚实的结果来确保这一点-然后，他将对付款最终会产生不信任的信心。不仅鲍勃可以做到这一点。任何有资金的人都可以以同样的方式将其借给爱丽丝和其他类似她的人。这些人可以通过提供较低的费用来相互竞争，从而降低了爱丽丝立即获得其资金的费用。

关键是这种市场机制的生存能力取决于无信任的确定性。如果“每个人”都已经知道最终将要确认该事物，那么对事物进行链上确认的延迟就不会造成不便。

这不仅适用于付款，而且适用于VM执行的其他操作。如果虚拟机将要发出一个宣布发生了某些事情的日志项目，那么无信任的终结性意味着任何人都可以肯定地采取行动，确保该日志项目将在链上被识别。

### 延迟攻击

由于该系统是不信任的，因此不良行为者不会强迫得出错误的结果。他们可以尝试做的是减慢进度。这样做需要他们牺牲赌注，如果赌注数量很大，这将是昂贵的。

假设有人有动机发起延迟攻击，而他们愿意牺牲赌注。他们能造成的最严重伤害是什么？

首先要注意的是，坏演员不能阻止诚实党继续树立诚实的分支。而且，他们不能阻止诚实的各方在最终确认诚实的分支机构时获得不信任的信心。

攻击者所能做的就是放错分支，以延迟对诚实路径的链上确认。他们所投入的每笔赌注都会对诚实党造成另一场争议，在诚实党中，攻击者所占的份额很大。一旦所有攻击者的赌注都被拿走，链上的进展将继续。

如果攻击者在错误的结果上多下赌注怎么办？然后，在争端中必须一一拿下那些赌注。如果有多个人参与诚实的结果，那么这些人都可以对攻击者提出争端，同时进行工作以取得攻击者的利益。并且请注意，对于所有人而言，发生的事情将是显而易见的，很多人都希望采取行动，坚持真正的结果，以便他们能够利用争端加入疯狂的人们手中，抢夺攻击者的赌注。如果有K个人在诚实方面进行赌注，那么将花费攻击者K赌注来购买一个延迟的争议期。如果攻击者放下更多的赌注，那么很可能会吸引更多诚实的赌注者。对于攻击者而言，这是一个糟糕的动态。

### 优化

可以进行各种优化来减少操作协议所需的链上簿记数量，降低链上天然气成本以及使针对延迟攻击者的有益馈送狂潮更易于安装。 本文档的目的是对汇总协议进行一般性的访问，因此，我们将不在此处进行优化。 但是，如果您担心实施此操作的成本，我们可以向您保证，EthBridge监控所有这些的成本将低于您的预期。 有关详细信息，您可以查阅Arbitrum Rollup代码。

## 更正式的协议描述

现在我们用一种更正式的方式来描述这个协议。

### 断言和子断言

首先，我们注意到在实践中，期货树不是二元的，而是四元的。 这是因为每个断言实际上包含三个子断言：收件箱顶部子断言，消息子断言和执行子断言。 因此，每个DA都会引发四个后继节点：（0）所有子断言都是正确的，（1）inbox-top是错误的，（2）inbox-top是正确的，但消息是错误的，（3）inbox-top和消息是正确的，但是执行是 是错的。 在树的每个点上，放样者都必须确定要支持的四种可能性中的哪一种

### 协议的状态

从逻辑上讲，协议的状态包括：

- LatestConfirmed节点：汇总树的节点，它是已在L1链上完全确认并执行的最新节点；
- 根植于LatestConfirmed的节点树，以及诱发该树的DA，包括这些DA的截止日期；
- 一组放样机，以及每个放样机在树的哪个节点上放样； 
- 和当前正在进行的一系列挑战。

### 挑战期

每个利益相关者一次最多只能面对一个挑战。 在任何时候，任何人都可以通过指向DA和两个放样者来发起挑战，使得（a）当前没有一个放样者正在挑战，并且（b）将两个放样者直接或间接地放到DA的不同子代上，并且（ c）两位利益相关者最初在发展议程的截止日期之前创建了他们的利益。 （只要满足上述三个条件，之间的挑战就可以在相关DA的截止日期之前或之后开始。）

一旦开始挑战，挑战协议将最终宣布两个风险承担者之一成为挑战的失败者。 失败者将失去他们的股份，并且将不再是股份人。 （失败者可以稍后再放注。）

### 创建质押

尚未成为放样者的任何一方都可以随时在树的任何节点上放样。 系统记录最初何时引入放款人的股份，以及在截止日为放款人之前的任何DA上“认为没有采取任何仓位”。

### 解除质押

任何放样者都可以通过将放样移动到树上该放样当前位置的后代中的任何节点上来“向右移动放样”。

### 恢复质押

如果放样者被放样到LatestConfirmed节点上，或者任何节点树中的节点的高度都小于LatestConfirmed节点，则放样者可以收回其放样。股份将返还给股份持有者，而该方不再是股份持有者。

在当前的实现中，有几个条件可以用来收回股份，这些条件共同涵盖了股份可能比LatestConfirmed变旧或以其他方式提出的所有方式。在实现中，如果满足以下条件，则可以收回利益：利益位于LatestConfirmed或它的前身，或者利益位于非LatestConfirmed且既不是LastConfirmed的前任也不是其后继的节点上。 （这样的赌注是“模拟的”或无关紧要的。它不能参与挑战，也不会影响确认哪个节点。因此，理性的赌注者将让这种赌注处于闲置状态，直到它比最新确认的早，然后将其收回。）当前的实施方式允许立即收回此类股份。）

此外，当前实现允许任何一方强行退还股份，如果该股份位于具有截止期限已过的后继者的节点上。这旨在激励利益相关者保持他们的利益前进。如果每个挑战期至少一次将利益攸关者转移到树的边界，则利益攸关者永远不会陷入这种情况。

### 断言并成长

被放到树的叶子节点上的放样者可以根据该叶子节点的状态进行新的“有争议的声明”。通过创建四个新节点作为该先前叶节点的子节点来生长树。主张权益者的权益被移至对应于新DA完全正确的子项。

### 确认节点

除非LatestConfirmed节点是树的叶子，否则从LatestConfirmed节点会断言某些DA。如果该DA的截止日期已过，并且如果在DA的截止日期之前介绍其股份的所有涉众都被放到了该节点的同一个子节点（或其后代）上（并且至少有一个这样的涉众），则可以确认子节点。它成为新的LatestConfirmed节点。

如果新确认的孩子对应于正确的DA，则在L1链上执行DA的所有副作用：付款并发送日志项。

### 修剪树

如果满足以下两个条件，则可以从树中修剪子树：（a）在子树的根节点是其截止期限已过的节点，并且（b）子树中没有在根的截止期限之前启动的股份。这样的子树本质上是没有意义的，因为关于是否可以输入子树没有争议。修剪子树后，任何在其中受害的人都将退还其利益。

该规则的唯一例外是无法修剪LatestConfirmed节点。

### 工程优化

EthBridge需要强制执行此协议的规则。为了节省存储空间，EthBridge不存储整个树，而是存储叶子的Merkle哈希（哈希链包括树的内部节点的Merkle哈希）以及有关LatestConfirmed节点的信息，每个利益相关者，以及任何正在进行的挑战。

上述状态更改可以由任何一方发起，他们可以向EthBridge发出txcall来强制状态更改。调用者提交任何必要的Merkle证明以允许EthBridge确认节点。 （控制权益的动作当然必须由该权益者发起。）

## 协议的正确性

### 安全性证明，假设一名诚实的质押人

假设有一个诚实的风险承担者，其权益是在LatestConfirmed节点的截止日期之前发起的（因此必定在LastConfirmed节点的任何后继者的截止日期之前）发起。

每个节点将只有一个有效的后继者，因为定义了一个节点的四个子节点的有效性条件，因此它们中的一个必须为真。因此，树上将只有一个有效的叶节点。

诚实的涉众可以通过始终对有效叶节点进行放样来强制安全。诚实的利益相关者将能够赢得所有挑战，因此其利益将永远存在。只要仍保留此股份，就不能确认LatestConfirmed的无效子级，因为诚实的股份持有人的股份在其他分支上的存在会伪造进行确认的条件之一。

因此，诚实的抵押者可以防止接受无效节点。

### 假设一名诚实的利益相关者，证明最终的进展

在与之前的证明相同的假设下，我们现在显示诚实的涉众可以强制最终接受某个有效的DA。

首先，我们显示一个有效的DA最终将被添加到LatestConfirmed的有效路径中。之所以如此，是因为诚实的涉众可以在有效路径上创建有效的DA（如果尚不存在）。

现在足以证明诚实的涉众可以确保LatestConfirmed节点最终前进。这是正确的，因为LatestConfirmed节点有一个最终期限，该期限最终将过去。截止日期过后，将有有限数量的利益相关者与诚实的利益相关者（即不正确的分支）相比被利益不同的分支。由于截止日期已过，此类不正确的风险承担者的数量将不再增加。诚实的风险承担者可以与这些不正确的风险承担者一一对应地发起挑战。诚实的利益相关者将被押在有效的分支机构中，将能够赢得这些挑战，从而一劳永逸地消除不正确的利益相关者。

一旦消除了所有不正确的放样者，诚实的放样者就可以使新节点得到确认。因此，最终将确认新的节点。

### 抑制对不正确分支机构的质押

假设至少有一个利益相关者合理地最大化了他们的收入，而其他每个利益相关者都不利于对不正确分支机构的利益。

如果放样者放样在不正确的分支上，则理性的放样者可以通过在正确的分支上放样并向不正确的放样者发起挑战来做出响应。理性的赌注者将能够赢得挑战并获得不正确的赌注者的赌注。

请注意，不正确的放款人无法通过安排与同盟之间的争端来保存自己的股份。因为争端的获胜者仅获得失败者一半的股份，另一半被烧毁，因此产生了相互勾结的派争执者中的r人将失去总数的一半，这会阻碍人们参与虚假的纠纷。

### 最终可收回诚实涉众的股份

一个诚实的利益相关者将永远能够收回他们的利益。 一个诚实的股东不会失去任何挑战，因此，一旦放置了股份，并且无论股份被转移到哪里，股份都将“保留在董事会上”。

而且，如果诚实的风险承担者停止移动其权益，则LatestConfirmed节点最终将赶上并超出诚实的风险承担者的权益的高度。 （如果链上没有任何活动，则放样者可以发布空声明，以确保LatestConfirmed的深度最终超过放样。）此时，放样者将能够收回其放样。